<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surron Squad 72V Build Selector</title>
  <link rel="stylesheet" href="surron_squad.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;500;600;700&family=Permanent+Marker&display=swap" rel="stylesheet">
  
  <!-- Add import map to resolve module paths -->
  <script type="importmap">
  {
    "imports": {
      "/surron_build/": "/surron_build/",
      "/game/": "/surron_build/game/",
      "/StateStackULTRA/": "/surron_build/StateStackULTRA/",
      "/DataStackULTRA/": "/surron_build/DataStackULTRA/",
      "/components/": "/surron_build/components/",
      "/ui/": "/surron_build/ui/"
    }
  }
  </script>
  
  <style>
    /* Additional styles specific to parts selector */
    .part-selector {
      background-color: rgba(23, 23, 25, 0.7);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-left: 4px solid var(--squad-primary);
      box-shadow: var(--squad-shadow);
    }
    
    .part-selector select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      background-color: var(--squad-dark);
      color: var(--squad-text);
      border: 1px solid var(--squad-border);
      margin-top: 0.5rem;
      font-family: 'Inter', sans-serif;
    }
    
    .part-selector select:focus {
      border-color: var(--squad-primary);
      box-shadow: 0 0 0 2px rgba(255, 72, 0, 0.2);
      outline: none;
    }
    
    .squad-comment {
      margin-top: 0.75rem;
      padding: 0.75rem 0.75rem 0.75rem 40px;
      border-radius: 8px;
      font-family: 'Permanent Marker', cursive;
      font-size: 0.9rem;
      position: relative;
      min-height: 50px;
      display: flex;
      align-items: center;
    }
    
    .squad-comment.charlie {
      background-color: rgba(230, 57, 70, 0.1);
      border-left: 3px solid #e63946;
      color: #e63946;
    }
    
    .squad-comment.billy {
      background-color: rgba(125, 130, 96, 0.1);
      border-left: 3px solid #7d8260;
      color: #7d8260;
    }
    
    .squad-comment.tbd {
      background-color: rgba(38, 70, 83, 0.1);
      border-left: 3px solid #264653;
      color: #264653;
    }
    
    .squad-comment:before {
      content: "";
      background-image: url('images/surron-charlie-alert-pose.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      width: 30px;
      height: 30px;
      position: absolute;
      left: 5px;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 50%;
    }
    
    .squad-comment.billy:before {
      background-image: url('images/surron-billy-fishing_ready-pose.png');
    }
    
    .squad-comment.tbd:before {
      background-image: url('images/surron-tbd-terminal-ready.png');
    }
    
    #total-price {
      font-size: 2rem;
      font-weight: bold;
      color: var(--squad-primary);
    }
    
    #selected-parts-list {
      list-style: none;
      padding: 0;
    }
    
    #selected-parts-list li {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background-color: rgba(23, 23, 25, 0.5);
      border-radius: 6px;
      border-left: 3px solid var(--squad-primary);
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .share-build {
      background: var(--squad-secondary);
    }
    
    .price-breakdown {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .price-label {
      font-size: 1.5rem;
      margin-right: 1rem;
    }
    
    .build-name-input {
      background-color: var(--squad-dark);
      color: var(--squad-text);
      border: 1px solid var(--squad-border);
      padding: 0.75rem;
      border-radius: 6px;
      margin-top: 1rem;
      width: 100%;
    }
    
    .build-name-input:focus {
      border-color: var(--squad-primary);
      outline: none;
    }
    
    .price-tag {
      animation: glow-pulse 2s infinite;
    }
    
    .error-message {
      background-color: rgba(230, 57, 70, 0.2);
      color: #e63946;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      display: none;
    }
    
    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="surron-squad-theme build-page">
  <div class="container">
    <div class="header">
      <h1 class="main-title">Configure Your Sur-Ron</h1>
      <p class="subtitle">Select premium parts for your custom 72V build</p>
      
      <div style="margin-bottom: 15px;">
        <a href="squad-hq.html" class="btn">‚Üê Back to Squad HQ</a>
        <a href="saved_builds.html" class="btn">üíæ Saved Builds</a>
      </div>
      
      <div id="player-stats" class="player-stats" style="display: none; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between;">
        <div>
          <span style="color: #39FF14; font-weight: bold;">Level:</span> <span id="player-level">1</span>
        </div>
        <div>
          <span style="color: #39FF14; font-weight: bold;">XP:</span> <span id="player-xp">0</span> / <span id="player-xp-next">100</span>
        </div>
        <div>
          <span style="color: #39FF14; font-weight: bold;">SurCoins:</span> <span id="player-coins">0</span>
        </div>
        <div>
          <span style="color: #39FF14; font-weight: bold;">Builds:</span> <span id="player-builds">0</span>
        </div>
      </div>
      
      <div id="error-message" class="error-message" style="display: none;">
        <p>Oops! Something went wrong loading parts. Charlie probably spilled pizza on the server.</p>
      </div>
    </div>

    <main>
      <section id="build-intro">
        <div class="squad-boxes">
          <div class="squad-member charlie">
            <div class="member-profile">
              <img src="images/surron-charlie-alert-pose.png" alt="Charlie 'Throttle' holding a pizza box and pointing dramatically">
            </div>
            <div class="member-details">
              <h3><span class="member-icon">üçï</span>Charlie <span class="nickname">"Throttle"</span></h3>
              <p class="quote">"Let's overvolt it. What's the worst that could happen? Third-degree burns are just spicy memories."</p>
            </div>
          </div>
          <div class="squad-member billy">
            <div class="member-profile">
              <img src="images/surron-billy-fishing_ready-pose.png" alt="Billy 'Baggin's' with fishing rod ready to fish">
            </div>
            <div class="member-details">
              <h3><span class="member-icon">üé£</span>Billy <span class="nickname">"Baggin's"</span></h3>
              <p class="quote">"I'd rather fish, but I guess we're building bikes. Again."</p>
            </div>
          </div>
          <div class="squad-member tbd">
            <div class="member-profile">
              <img src="images/surron-tbd-terminal-ready.png" alt="TBD 'TBD' working on a laptop with perfect beard">
            </div>
            <div class="member-details">
              <h3><span class="member-icon">üß†</span>TBD <span class="nickname">"TBD"</span></h3>
              <p class="quote">"Parts compatibility matrix loaded. Efficiency optimization at 97.3%."</p>
            </div>
          </div>
        </div>
      </section>

      <div class="two-column">
        <section id="parts-select-section" class="column">
          <h2>Select Your Parts</h2>
          <p class="section-intro">Configure your 72V Sur-Ron build with real parts and pricing from our strange cast of experts:</p>
          <div id="parts-select"></div>
        </section>

        <section id="summary" class="column">
          <h2>Build Summary</h2>
          <input type="text" class="build-name-input" id="build-name" placeholder="Name your build (e.g. 'Thunder Donkey 3000')">
          
          <div id="build-summary">
            <div class="price-breakdown">
              <span class="price-label">Total:</span>
              <div class="price-tag">
                <span id="total-price">$0</span>
              </div>
            </div>
            <ul id="selected-parts-list"></ul>
          </div>
          
          <div class="squad-comment" id="build-comment">
            Name your build and select some parts to get Squad commentary!
          </div>
          
          <div class="build-actions">
            <button id="saveBuild" class="btn-save">Save Build</button>
            <button id="share-build-btn" class="btn-share" onclick="shareBuild()">Share Build</button>
            <button id="show-charlie-btn" class="btn-charlie" onclick="showCharlieGame()">Show to Charlie</button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Tuning Game Modal -->
  <div class="modal" id="tuning-game-modal">
    <div class="modal-content" style="max-width: 700px;">
      <button class="close-modal">&times;</button>
      <h2 class="modal-title">Charlie's Bike Tuning Station</h2>
      <div id="tuning-game-container"></div>
    </div>
  </div>

  <script src="surron_squad.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <!-- Import GameCore and other modules properly -->
  <script type="module">
    // Import required modules with correct paths
    import GameCore from './game/GameCore.js';
    import { forceCreateMainModel } from './DataStackULTRA/models/main.js';
    import { showToast } from './game/popup-toast.js';
    
    // Make GameCore available globally for older scripts that expect it
    window.GameCore = GameCore;
    window.showToast = showToast;
    
    // Load parts data using fetch
    async function loadParts() {
      try {
        const response = await fetch('./s_parts.json');
        if (!response.ok) {
          throw new Error('Failed to load parts data');
        }
        const partsData = await response.json();
        window.partsData = partsData;
        initializePartSelectors(partsData);
      } catch (error) {
        console.error("Error loading parts data:", error);
        document.getElementById('error-message').style.display = 'block';
      }
    }
    
    // Initialize GameCore and setup UI
    document.addEventListener('DOMContentLoaded', async function() {
      console.log("DOM loaded, initializing GameCore...");
      
      try {
        // Force create main model to avoid errors
        await forceCreateMainModel();
        
        // Initialize GameCore (loads player state from storage)
        await GameCore.boot();
        console.log("GameCore initialized");
        
        // Show player stats
        updatePlayerStats();
        document.getElementById('player-stats').style.display = 'flex';
        
        // Load parts data
        await loadParts();
        
        // Try to load the BuildSelectorComponent
        try {
          const BuildSelectorComponent = await import('./components/BuildSelectorComponent.js');
          console.log("BuildSelectorComponent loaded");
          
          // Mount the component to the parts-select div
          const selector = new BuildSelectorComponent.default();
          selector.mount(document.getElementById('parts-select'));
        } catch (error) {
          console.error("Error loading BuildSelectorComponent:", error);
          
          // If component fails, still try to initialize legacy selector
          if (window.partsData) {
            initializePartSelectors(window.partsData);
          }
        }
        
      } catch (error) {
        console.error("Error initializing GameCore:", error);
        document.getElementById('error-message').style.display = 'block';
      }
    });
    
    // Make these functions available to global scope
    window.loadParts = loadParts;
    
    // Legacy parts selector initialization function
    function initializePartSelectors(partsData) {
      try {
        const partsContainer = document.getElementById('parts-select');
        if (!partsContainer) return;
        
        // Group parts by category
        const partsByCategory = _.groupBy(partsData, 'Category');
        
        // Generate HTML for part selectors
        const categories = Object.keys(partsByCategory);
        
        categories.forEach(category => {
          const parts = partsByCategory[category];
          
          // Create category selector
          const selectorDiv = document.createElement('div');
          selectorDiv.className = 'part-selector';
          selectorDiv.innerHTML = `
            <h3>${category}</h3>
            <p>${parts[0]['Part Name & Details']}</p>
            <select class="part-option" data-category="${category}">
              <option value="">Select an option</option>
              ${parts.map((part, index) => `
                <option value="${index}" data-price="${extractPrice(part['Sourcing Option 1 (Price - Vendor)'])}">${part['Sourcing Option 1 (Price - Vendor)']}</option>
                <option value="${index}" data-price="${extractPrice(part['Sourcing Option 2 (Price - Vendor)'])}">${part['Sourcing Option 2 (Price - Vendor)']}</option>
              `).join('')}
            </select>
            <div class="squad-comment"></div>
          `;
          
          partsContainer.appendChild(selectorDiv);
          
          // Add change event listener
          const select = selectorDiv.querySelector('select');
          select.addEventListener('change', handlePartSelection);
        });
        
        console.log("Parts selectors initialized");
      } catch (error) {
        console.error("Error initializing parts selectors:", error);
        document.getElementById('error-message').style.display = 'block';
      }
    }
    
    // Add to global scope
    window.initializePartSelectors = initializePartSelectors;
  </script>

  <script>
    // Parts selection logic
    let selectedParts = {};
    let totalPrice = 0;
    
    // Define updatePlayerStats in global scope for both modules to use
    function updatePlayerStats() {
      try {
        const playerState = window.GameCore ? window.GameCore.getPlayerState() : null;
        if (!playerState) return;
        
        document.getElementById('player-level').textContent = playerState.level;
        document.getElementById('player-xp').textContent = playerState.xp;
        document.getElementById('player-xp-next').textContent = playerState.xpToNextLevel;
        document.getElementById('player-coins').textContent = playerState.currency;
        document.getElementById('player-builds').textContent = playerState.builds ? playerState.builds.length : 0;
      } catch (error) {
        console.error("Error updating player stats:", error);
      }
    }
    
    // Character-specific comments for each part category
    const squadComments = {
      'Frame': {
        charlie: "If it bends, it's temporary. If it breaks, you needed a new one anyway.",
        billy: "Make sure it fits in the truck. And has a place for my tackle box.",
        tbd: "Structural integrity calculations complete. This will hold. Probably."
      },
      'Motor': {
        charlie: "More power! MORE POWER! Did I mention we need more power?",
        billy: "Can we make it quieter? The fish can hear us coming from a mile away.",
        tbd: "Thermal management is critical. I've installed additional sensors on mine."
      },
      'Battery': {
        charlie: "Bigger is better! And if it catches fire, that's just bonus heat for winter rides.",
        billy: "I just want it to last the whole fishing trip without dying on the way back.",
        tbd: "I've developed a custom BMS. 42.7% more efficient than commercial options."
      },
      'Controller': {
        charlie: "Does it have ludicrous mode? It needs ludicrous mode.",
        billy: "Make sure it's waterproof. You know, for reasons.",
        tbd: "I've modified my firmware to optimize for torque delivery during creek crossings."
      },
      'Suspension ‚Äì Front': {
        charlie: "Stiffer isn't always better... except when it is. SEND IT!",
        billy: "Good front suspension means I can bring more beers without them exploding.",
        tbd: "I've mapped the optimal compression settings for 17 different terrain types."
      },
      'Suspension ‚Äì Rear': {
        charlie: "This is what separates the riders from the cryers. Go big or go to the hospital!",
        billy: "The rear shock is important when Charlie talks you into terrible ideas.",
        tbd: "My telemetry indicates the stock spring rate is insufficient for optimal damping."
      },
      'Brakes': {
        charlie: "Brakes are for people who don't commit. But I guess we need them sometimes.",
        billy: "The most important part of the bike, especially when riding with Charlie.",
        tbd: "Brake fluid temperature becomes critical after 7.2 minutes of sustained downhill."
      },
      'Wheels': {
        charlie: "These things take ABUSE. Go strong or go walking!",
        billy: "Wheels are like good fishing spots. Everyone has opinions, most are wrong.",
        tbd: "I've calculated the optimal spoke tension for maximum torsional rigidity."
      },
      'Electronics ‚Äì Throttle & Controls': {
        charlie: "The more sensitive the better. I want it to MOVE when I twitch!",
        billy: "I just want a throttle that works when my hands are cold and wet.",
        tbd: "My throttle response curve has been recalibrated 27 times for optimal delivery."
      },
      'Electronics ‚Äì Wiring': {
        charlie: "Zip ties and electrical tape. The universal solution to everything.",
        billy: "Label everything. Future you will thank you when something breaks.",
        tbd: "I've created a redundant parallel circuit for critical systems."
      },
      'Charger': {
        charlie: "Faster charging means more riding! Science!",
        billy: "Don't cheap out here. A fire in the garage is bad for the fishing gear.",
        tbd: "My charging algorithm extends cell life by an estimated 34.8%."
      }
    };
    
    // Handle part selection from dropdown
    function handlePartSelection(event) {
      try {
        const select = event.target;
        const category = select.dataset.category;
        const selectedOption = select.options[select.selectedIndex];
        const price = parseFloat(selectedOption.dataset.price) || 0;
        const selection = selectedOption.text;
        
        // Update selected parts
        if (price > 0) {
          selectedParts[category] = { price, selection };
        } else {
          delete selectedParts[category];
        }
        
        // Update total price
        calculateTotalPrice();
        
        // Update comment for this part
        updatePartComment(select, category);
        
        // Update parts list and build summary
        updateSelectedPartsList();
        updateBuildComment();
      } catch (error) {
        console.error("Error handling part selection:", error);
      }
    }
    
    // Calculate total price of selected parts
    function calculateTotalPrice() {
      totalPrice = Object.values(selectedParts).reduce((sum, item) => sum + item.price, 0);
      document.getElementById('total-price').textContent = formatCurrency(totalPrice);
    }
    
    // Update the comment for a selected part
    function updatePartComment(select, category) {
      // Find the comment element
      const commentEl = select.closest('.part-selector').querySelector('.squad-comment');
      if (!commentEl) return;
      
      // Map category to comment category
      const commentCategory = mapCategoryToSquadCommentCategory(category);
      
      // If no selection, clear the comment
      if (!selectedParts[category]) {
        commentEl.textContent = '';
        commentEl.className = 'squad-comment';
        return;
      }
      
      // Choose a squad member and their comment
      let member, comment;
      
      if (squadComments[commentCategory]) {
        // Get random squad member
        const members = Object.keys(squadComments[commentCategory]);
        member = members[Math.floor(Math.random() * members.length)];
        comment = squadComments[commentCategory][member];
      } else {
        // Fallback for categories without specific comments
        const members = ['charlie', 'billy', 'tbd'];
        member = members[Math.floor(Math.random() * members.length)];
        
        if (member === 'charlie') {
          comment = `This ${category} looks awesome! Let's put it to the test!`;
        } else if (member === 'billy') {
          comment = `A good ${category} is worth every penny.`;
        } else {
          comment = `${category} specifications are within acceptable parameters.`;
        }
      }
      
      // Update comment
      commentEl.textContent = comment;
      commentEl.className = `squad-comment ${member}`;
    }
    
    // Map category to squadComment category
    function mapCategoryToSquadCommentCategory(category) {
      const categoryMap = {
        "Front Suspension": "Suspension ‚Äì Front",
        "Rear Suspension": "Suspension ‚Äì Rear",
        "Wheels & Tires": "Wheels",
        "Handlebars & Controls": "Electronics ‚Äì Throttle & Controls",
        "Throttle": "Electronics ‚Äì Throttle & Controls",
        "Wiring & Display": "Electronics ‚Äì Wiring"
      };
      
      return categoryMap[category] || category;
    }
    
    // Update the selected parts list in the summary
    function updateSelectedPartsList() {
      const listEl = document.getElementById('selected-parts-list');
      listEl.innerHTML = '';
      
      Object.entries(selectedParts).forEach(([category, { selection, price }]) => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${category}:</strong> ${selection} <span class="part-price">(${formatCurrency(price)})</span>`;
        listEl.appendChild(li);
      });
    }
    
    // Update the overall build comment
    function updateBuildComment() {
      const commentEl = document.getElementById('build-comment');
      if (!commentEl) return;
      
      // If no parts selected, show default message
      if (Object.keys(selectedParts).length === 0) {
        commentEl.textContent = 'Name your build and select some parts to get Squad commentary!';
        commentEl.className = 'squad-comment';
        return;
      }
      
      // Get build name
      const buildName = document.getElementById('build-name').value || 'your build';
      
      // Get random comment based on price
      const comment = getRandomBuildComment(totalPrice, buildName);
      commentEl.textContent = comment.text;
      commentEl.className = `squad-comment ${comment.character}`;
    }

    // Random build comments based on total price
    function getRandomBuildComment(price, name) {
      const buildName = name || "your build";
      
      // Comments for different price ranges
      const priceComments = {
        cheap: [
          { character: "charlie", text: `${buildName}? More like "Budget Betty." But hey, it'll probably survive... the driveway.` },
          { character: "billy", text: `${buildName} looks reasonable. At least you'll have money left for fishing gear.` },
          { character: "tbd", text: `${buildName} is operating at 67.2% of optimal performance potential. Acceptable for beginners.` }
        ],
        mid: [
          { character: "charlie", text: `${buildName} is getting there! Might survive a weekend with the squad.` },
          { character: "billy", text: `${buildName} looks solid. Should get you to the lake and back without breaking down.` },
          { character: "tbd", text: `${buildName} achieves 82.4% performance efficiency. A statistically sound build.` }
        ],
        expensive: [
          { character: "charlie", text: `DUDE! ${buildName} is INSANE! Let's go break it in spectacular fashion!` },
          { character: "billy", text: `Wow. ${buildName} costs more than my first truck. Better not get it muddy... but we will.` },
          { character: "tbd", text: `${buildName} approaches theoretical performance limits. I've added it to my database.` }
        ]
      };
      
      // Determine price range
      let range;
      if (price < 4000) range = "cheap";
      else if (price < 7000) range = "mid";
      else range = "expensive";
      
      // Get random comment for this price range
      const comments = priceComments[range];
      return comments[Math.floor(Math.random() * comments.length)];
    }

    // Format currency properly
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount);
    }

    // Extract price from string safely
    function extractPrice(priceString) {
      // This improved regex handles commas in price format
      const match = priceString.match(/\$([0-9,]+(?:\.[0-9]+)?)/);
      if (match && match[1]) {
        // Remove commas before parsing
        return parseFloat(match[1].replace(/,/g, ''));
      }
      return 0;
    }

    function updateSummary() {
      const selections = document.querySelectorAll("#parts-select select");
      const list = document.getElementById("selected-parts-list");
      const total = document.getElementById("total-price");
      const buildName = document.getElementById("build-name").value;
      list.innerHTML = "";

      let sum = 0;
      selections.forEach(sel => {
        const category = sel.dataset.category;
        const option = sel.options[sel.selectedIndex];
        const price = parseFloat(option.value);
        sum += price;

        const li = document.createElement("li");
        li.textContent = `${category}: ${option.textContent}`;
        list.appendChild(li);
      });

      total.textContent = formatCurrency(sum);
      
      // Update squad comment on the build
      const buildComment = document.getElementById("build-comment");
      const comment = getRandomBuildComment(sum, buildName);
      buildComment.className = `squad-comment ${comment.character}`;
      buildComment.textContent = comment.text;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadPartsFromJSON();
      
      // Handle build name changes
      document.getElementById("build-name").addEventListener("input", updateSummary);
      
      // Handle share button
      document.getElementById("share-build-btn").addEventListener("click", shareBuild);
      
      // Wait for player state to be ready
      updatePlayerStats();
      document.getElementById('player-stats').style.display = 'flex';
      
      // Handle the save button click manually
      const saveBuildBtn = document.getElementById('saveBuild');
      if (saveBuildBtn) {
        saveBuildBtn.addEventListener('click', function() {
          // Prepare build data for BuildIntegration
          try {
            // Get build name
            const buildName = document.getElementById('build-name').value.trim();
            if (!buildName) {
              alert('Please enter a name for your build!');
              return;
            }
            
            // Get all selected parts
            const selections = document.querySelectorAll('#parts-select select');
            const parts = [];
            
            selections.forEach(sel => {
              const category = sel.dataset.category;
              const option = sel.options[sel.selectedIndex];
              const price = parseFloat(option.value);
              
              parts.push({
                category: category,
                option: option.textContent,
                price: price
              });
            });
            
            // Calculate total price
            const totalPrice = parts.reduce((sum, part) => sum + part.price, 0);
            
            // Create build object to pass to BuildIntegration
            const buildData = {
              id: buildName.toLowerCase().replace(/[^a-z0-9]/g, '_'),
              name: buildName,
              parts: parts,
              totalPrice: totalPrice,
              date: new Date().toISOString(),
              // These properties are used by BuildIntegration.js
              xp: 80,
              surCoins: 150,
              items: [
                { id: 'battery_pack', name: 'Battery Pack', quantity: 1 },
                { id: 'controller_unit', name: 'Controller', quantity: 1 }
              ]
            };
            
            // Save to localStorage (for backward compatibility)
            const savedBuilds = JSON.parse(localStorage.getItem('surronSquadBuilds') || '[]');
            savedBuilds.push(buildData);
            localStorage.setItem('surronSquadBuilds', JSON.stringify(savedBuilds));
            
            console.log('Build saved:', buildData);
          } catch (error) {
            console.error('Error preparing build data:', error);
          }
        });
      }
    });

    function loadSavedBuilds() {
      try {
        // Check if we have a loadBuild parameter in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const loadBuildIndex = urlParams.get('loadBuild');
        
        if (loadBuildIndex !== null) {
          // We're loading a specific build from the saved builds page
          const savedBuilds = JSON.parse(localStorage.getItem('surronSquadBuilds') || '[]');
          
          if (savedBuilds.length > 0 && savedBuilds[loadBuildIndex]) {
            const buildToLoad = savedBuilds[loadBuildIndex];
            
            // Set the build name
            document.getElementById('build-name').value = buildToLoad.name;
            
            // Set the selections based on part prices
            const selects = document.querySelectorAll('#parts-select select');
            
            buildToLoad.parts.forEach(savedPart => {
              // Find the select element for this category
              const categorySelect = Array.from(selects).find(
                select => select.dataset.category === savedPart.category
              );
              
              if (categorySelect) {
                // Find the option with the matching price
                const options = Array.from(categorySelect.options);
                const matchingOption = options.find(
                  option => Math.abs(parseFloat(option.value) - savedPart.price) < 0.01
                );
                
                if (matchingOption) {
                  categorySelect.value = matchingOption.value;
                }
              }
            });
            
            // Update the summary to reflect the loaded build
            updateSummary();
            
            // Show a success message
            alert(`"${buildToLoad.name}" loaded successfully!`);
            
            return; // Exit early, we've loaded the build
          }
        }
        
        // If we didn't load a specific build, check if we should suggest loading one
        const savedBuilds = JSON.parse(localStorage.getItem('surronSquadBuilds') || '[]');
        
        if (savedBuilds.length > 0 && confirm('You have saved builds. Would you like to load your most recent build?')) {
          // Get most recent build
          const mostRecent = savedBuilds[savedBuilds.length - 1];
          
          // Set the build name
          document.getElementById('build-name').value = mostRecent.name;
          
          // TODO: Set the selections based on part names
          // This would require matching the part categories and options
          
          // Update the summary
          if (typeof updateSummary === 'function') {
            updateSummary();
          }
        }
      } catch (error) {
        console.error('Error loading saved builds:', error);
      }
    }
    
    // Function to check for parts selections from the main build page
    function checkForPartSelections() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const fromSelection = urlParams.get('fromSelection');
        
        if (fromSelection === 'true') {
          // Get selected parts from localStorage
          const selectedParts = JSON.parse(localStorage.getItem('selectedSurronParts') || '[]');
          
          if (selectedParts.length > 0) {
            // Map the selected parts to the corresponding categories
            const partCategoryMap = {
              0: 'Frame', // Frame & Chassis maps to Frame
              1: 'Motor',
              2: 'Battery',
              3: 'Controller',
              4: 'Suspension ‚Äì Front', // Suspension maps to Front Suspension (simplified)
              5: 'Brakes',
              7: 'Wheels', // Wheels & Tires maps to Wheels
              8: 'Electronics ‚Äì Throttle & Controls', // Electrical Components maps to Electronics
              9: 'Charger'
            };
            
            // Get all select elements
            const selects = document.querySelectorAll('#parts-select select');
            
            // For each selected part, select the corresponding option (default to option 1)
            selectedParts.forEach(partIndex => {
              const mappedCategory = partCategoryMap[partIndex];
              
              if (mappedCategory) {
                // Find the select for this category
                const categorySelect = Array.from(selects).find(
                  select => select.dataset.category === mappedCategory
                );
                
                if (categorySelect && categorySelect.options.length > 0) {
                  // Default to first option (typically cheaper)
                  categorySelect.selectedIndex = 0;
                }
              }
            });
            
            // Set a default build name that includes the number of selected components
            document.getElementById('build-name').value = `Custom ${selectedParts.length}-Part Build`;
            
            // Update the summary
            updateSummary();
            
            // Show success message
            alert(`Your selected components (${selectedParts.length}) have been loaded! Review and customize your build.`);
          }
        }
      } catch (error) {
        console.error('Error processing selected parts:', error);
      }
    }
    
    function shareBuild() {
      alert("The squad would love to see this build, but social sharing is coming in a future update. For now, save your build and show your friends on your device!");
    }
    
    function showCharlieGame() {
      // Check if player has at least one build
      try {
        const savedBuilds = JSON.parse(localStorage.getItem('surronSquadBuilds') || '[]');
        
        if (savedBuilds.length === 0) {
          alert("You need to save a build first before showing it to Charlie!");
          return;
        }
        
        // Show the tuning game modal
        const modal = document.getElementById('tuning-game-modal');
        if (!modal) return;
        
        modal.style.display = 'block';
        
        // Initialize the tuning game
        import('./bike-tuning-game.js').then(module => {
          const gameContainer = document.getElementById('tuning-game-container');
          if (!gameContainer) return;
          
          // Start the tuning game
          const game = module.startTuningGame('tuning-game-container');
          
          // Listen for game completion
          gameContainer.addEventListener('build-shown', (event) => {
            const result = event.detail;
            
            // Handle the result
            if (result.score >= 75) {
              // Success - complete Charlie's quest if available
              if (window.gameBridge) {
                // Complete the mission
                window.gameBridge.completeMission('charlie_build_review');
                
                // Show success toast
                if (window.toast) {
                  window.toast.show('Charlie approved your build! Quest completed.', 'success');
                } else {
                  alert('Charlie approved your build! Quest completed.');
                }
                
                // Refresh quest board if it exists
                if (typeof window.updateQuestBoard === 'function') {
                  window.updateQuestBoard();
                }
              } else {
                // Fallback if gameBridge not available
                alert('Charlie loves your build! "It\'s going to absolutely RIP!"');
              }
            } else {
              // Not good enough
              alert('Charlie thinks your build needs more work: "Is this a bicycle? WHERE\'S THE POWER?"');
            }
            
            // Close modal
            modal.style.display = 'none';
          });
        }).catch(err => {
          console.error('Error loading tuning game:', err);
          alert('Could not load Charlie\'s tuning station. Try again later.');
        });
      } catch (error) {
        console.error('Error checking builds:', error);
        alert('There was an error. Please try again.');
      }
    }
    
    // Add event listeners for modal close buttons
    document.querySelectorAll('.close-modal').forEach(button => {
      button.addEventListener('click', () => {
        // Get the parent modal
        const modal = button.closest('.modal');
        if (modal) modal.style.display = 'none';
      });
    });
    
    // Add CSS for the Charlie button
    document.head.insertAdjacentHTML('beforeend', `
      <style>
        .btn-charlie {
          background: linear-gradient(45deg, #FF5722, #FF9800);
          color: white;
          border: none;
          border-radius: 4px;
          padding: 0.75rem 1.5rem;
          font-family: 'Rajdhani', sans-serif;
          font-weight: bold;
          font-size: 1rem;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-charlie:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
          background-color: var(--squad-dark);
          margin: 5% auto;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 0 30px rgba(0,0,0,0.5);
          position: relative;
          width: 80%;
        }
        
        .close-modal {
          position: absolute;
          right: 10px;
          top: 10px;
          color: white;
          background: rgba(0,0,0,0.3);
          width: 30px;
          height: 30px;
          border: none;
          border-radius: 50%;
          font-size: 20px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .modal-title {
          font-family: 'Bangers', cursive;
          color: var(--squad-neon);
          text-align: center;
          margin-top: 0;
        }
      </style>
    `);
  </script>
  
  <!-- Import BuildSelectorComponent with type="module" -->
  <script type="module">
    import BuildSelectorComponent from './components/BuildSelectorComponent.js';
    
    // Initialize the component when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Create and mount the BuildSelectorComponent
      const buildSelector = new BuildSelectorComponent();
      
      // Mount the component to an existing container
      const mainContainer = document.getElementById('parts-select-section');
      if (mainContainer) {
        buildSelector.mount(mainContainer);
      }
    });
  </script>
</body>
</html>
