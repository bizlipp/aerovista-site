<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surron Squad 72V Build Selector</title>
  <link rel="stylesheet" href="surron_squad.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;500;600;700&family=Permanent+Marker&display=swap" rel="stylesheet">
  <style>
    /* Additional styles specific to parts selector */
    .part-selector {
      background-color: rgba(23, 23, 25, 0.7);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-left: 4px solid var(--squad-primary);
      box-shadow: var(--squad-shadow);
    }
    
    .part-selector select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      background-color: var(--squad-dark);
      color: var(--squad-text);
      border: 1px solid var(--squad-border);
      margin-top: 0.5rem;
      font-family: 'Inter', sans-serif;
    }
    
    .part-selector select:focus {
      border-color: var(--squad-primary);
      box-shadow: 0 0 0 2px rgba(255, 72, 0, 0.2);
      outline: none;
    }
    
    .squad-comment {
      margin-top: 0.75rem;
      padding: 0.75rem 0.75rem 0.75rem 40px;
      border-radius: 8px;
      font-family: 'Permanent Marker', cursive;
      font-size: 0.9rem;
      position: relative;
      min-height: 50px;
      display: flex;
      align-items: center;
    }
    
    .squad-comment.charlie {
      background-color: rgba(230, 57, 70, 0.1);
      border-left: 3px solid #e63946;
      color: #e63946;
    }
    
    .squad-comment.billy {
      background-color: rgba(125, 130, 96, 0.1);
      border-left: 3px solid #7d8260;
      color: #7d8260;
    }
    
    .squad-comment.tbd {
      background-color: rgba(38, 70, 83, 0.1);
      border-left: 3px solid #264653;
      color: #264653;
    }
    
    .squad-comment:before {
      content: "";
      background-image: url('images/surron-charlie-alert-pose.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      width: 30px;
      height: 30px;
      position: absolute;
      left: 5px;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 50%;
    }
    
    .squad-comment.billy:before {
      background-image: url('images/surron-billy-fishing_ready-pose.png');
    }
    
    .squad-comment.tbd:before {
      background-image: url('images/surron-tbd-terminal-ready.png');
    }
    
    #total-price {
      font-size: 2rem;
      font-weight: bold;
      color: var(--squad-primary);
    }
    
    #selected-parts-list {
      list-style: none;
      padding: 0;
    }
    
    #selected-parts-list li {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background-color: rgba(23, 23, 25, 0.5);
      border-radius: 6px;
      border-left: 3px solid var(--squad-primary);
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .share-build {
      background: var(--squad-secondary);
    }
    
    .price-breakdown {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .price-label {
      font-size: 1.5rem;
      margin-right: 1rem;
    }
    
    .build-name-input {
      background-color: var(--squad-dark);
      color: var(--squad-text);
      border: 1px solid var(--squad-border);
      padding: 0.75rem;
      border-radius: 6px;
      margin-top: 1rem;
      width: 100%;
    }
    
    .build-name-input:focus {
      border-color: var(--squad-primary);
      outline: none;
    }
    
    .price-tag {
      animation: glow-pulse 2s infinite;
    }
    
    .error-message {
      background-color: rgba(230, 57, 70, 0.2);
      color: #e63946;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      display: none;
    }
    
    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="surron-squad-theme">
  <div class="container">
    <div class="header">
      <h1 class="main-title">Configure Your Sur-Ron</h1>
      <p class="subtitle">Select premium parts for your custom 72V build</p>
      
      <div style="margin-bottom: 15px;">
        <a href="squad-hq.html" class="btn">‚Üê Back to Squad HQ</a>
        <a href="saved_builds.html" class="btn">üíæ Saved Builds</a>
      </div>
      
      <div id="player-stats" class="player-stats" style="display: none; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between;">
        <div>
          <span style="color: #39FF14; font-weight: bold;">Level:</span> <span id="player-level">1</span>
        </div>
        <div>
          <span style="color: #39FF14; font-weight: bold;">XP:</span> <span id="player-xp">0</span> / <span id="player-xp-next">100</span>
        </div>
        <div>
          <span style="color: #39FF14; font-weight: bold;">SurCoins:</span> <span id="player-coins">0</span>
        </div>
        <div>
          <span style="color: #39FF14; font-weight: bold;">Builds:</span> <span id="player-builds">0</span>
        </div>
      </div>
      
      <div id="error-message" class="error-message" style="display: none;">
        <p>Oops! Something went wrong loading parts. Charlie probably spilled pizza on the server.</p>
      </div>
    </div>

    <main>
      <section id="build-intro">
        <div class="squad-boxes">
          <div class="squad-member charlie">
            <div class="member-profile">
              <img src="images/surron-charlie-alert-pose.png" alt="Charlie 'Throttle' holding a pizza box and pointing dramatically">
            </div>
            <div class="member-details">
              <h3><span class="member-icon">üçï</span>Charlie <span class="nickname">"Throttle"</span></h3>
              <p class="quote">"Let's overvolt it. What's the worst that could happen? Third-degree burns are just spicy memories."</p>
            </div>
          </div>
          <div class="squad-member billy">
            <div class="member-profile">
              <img src="images/surron-billy-fishing_ready-pose.png" alt="Billy 'Baggin's' with fishing rod ready to fish">
            </div>
            <div class="member-details">
              <h3><span class="member-icon">üé£</span>Billy <span class="nickname">"Baggin's"</span></h3>
              <p class="quote">"I'd rather fish, but I guess we're building bikes. Again."</p>
            </div>
          </div>
          <div class="squad-member tbd">
            <div class="member-profile">
              <img src="images/surron-tbd-terminal-ready.png" alt="TBD 'TBD' working on a laptop with perfect beard">
            </div>
            <div class="member-details">
              <h3><span class="member-icon">üß†</span>TBD <span class="nickname">"TBD"</span></h3>
              <p class="quote">"Parts compatibility matrix loaded. Efficiency optimization at 97.3%."</p>
            </div>
          </div>
        </div>
      </section>

      <div class="two-column">
        <section id="parts-select-section" class="column">
          <h2>Select Your Parts</h2>
          <p class="section-intro">Configure your 72V Sur-Ron build with real parts and pricing from our strange cast of experts:</p>
          <div id="parts-select"></div>
        </section>

        <section id="summary" class="column">
          <h2>Build Summary</h2>
          <input type="text" class="build-name-input" id="build-name" placeholder="Name your build (e.g. 'Thunder Donkey 3000')">
          
          <div id="build-summary">
            <div class="price-breakdown">
              <span class="price-label">Total:</span>
              <div class="price-tag">
                <span id="total-price">$0</span>
              </div>
            </div>
            <ul id="selected-parts-list"></ul>
          </div>
          
          <div class="squad-comment" id="build-comment">
            Name your build and select some parts to get Squad commentary!
          </div>
          
          <div class="action-buttons">
            <button class="btn" id="save-build">Save Build</button>
            <button class="btn share-build" id="share-build">Share with Squad</button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script src="surron_squad.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script src="s_parts.json" type="text/javascript"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- Import GameCore instead of player-state.js -->
  <script type="module">
    import GameCore from './game/GameCore.js';
    
    // Make GameCore available globally for older scripts that expect it
    window.GameCore = GameCore;
    
    // Initialize GameCore and setup UI
    document.addEventListener('DOMContentLoaded', async function() {
      console.log("DOM loaded, initializing GameCore...");
      
      try {
        // Initialize GameCore (loads player state from storage)
        await GameCore.boot();
        console.log("GameCore initialized");
        
        // Show player stats
        updatePlayerStats();
        document.getElementById('player-stats').style.display = 'flex';
      } catch (error) {
        console.error("Error initializing GameCore:", error);
      }
    });
    
    // Update player stats in UI
    function updatePlayerStats() {
      const playerState = GameCore.getPlayerState();
      if (!playerState) return;
      
      document.getElementById('player-level').textContent = playerState.level;
      document.getElementById('player-xp').textContent = playerState.xp;
      document.getElementById('player-xp-next').textContent = playerState.xpToNextLevel;
      document.getElementById('player-coins').textContent = playerState.currency;
      document.getElementById('player-builds').textContent = playerState.builds ? playerState.builds.length : 0;
    }
    
    // Add a build to player state
    window.saveBuild = function(build) {
      // Get current player state
      const playerState = GameCore.getPlayerState();
      if (playerState) {
        console.log("Saving build:", build);
        
        // Check if builds array exists, create if not
        if (!playerState.builds) {
          console.log("Creating builds array");
          // Player state modification needs to happen through GameCore actions
          GameCore.store.dispatch({
            type: 'player/initBuilds',
            payload: []
          });
        }
        
        // Add the build using GameCore
        GameCore.store.dispatch({
          type: 'player/addBuild',
          payload: build
        });
        
        // Save changes to storage
        GameCore.save();
        
        // Add XP for creating a build
        GameCore.addXP(50);
        
        // Update UI
        updatePlayerStats();
        
        return true;
      }
      return false;
    };
  </script>

  <script>
    // Parts selection logic
    let selectedParts = {};
    let totalPrice = 0;
    
    // Character-specific comments for each part category
    const squadComments = {
      'Frame': {
        charlie: "If it bends, it's temporary. If it breaks, you needed a new one anyway.",
        billy: "Make sure it fits in the truck. And has a place for my tackle box.",
        tbd: "Structural integrity calculations complete. This will hold. Probably."
      },
      'Motor': {
        charlie: "More power! MORE POWER! Did I mention we need more power?",
        billy: "Can we make it quieter? The fish can hear us coming from a mile away.",
        tbd: "Thermal management is critical. I've installed additional sensors on mine."
      },
      'Battery': {
        charlie: "Bigger is better! And if it catches fire, that's just bonus heat for winter rides.",
        billy: "I just want it to last the whole fishing trip without dying on the way back.",
        tbd: "I've developed a custom BMS. 42.7% more efficient than commercial options."
      },
      'Controller': {
        charlie: "Does it have ludicrous mode? It needs ludicrous mode.",
        billy: "Make sure it's waterproof. You know, for reasons.",
        tbd: "I've modified my firmware to optimize for torque delivery during creek crossings."
      },
      'Suspension ‚Äì Front': {
        charlie: "Stiffer isn't always better... except when it is. SEND IT!",
        billy: "Good front suspension means I can bring more beers without them exploding.",
        tbd: "I've mapped the optimal compression settings for 17 different terrain types."
      },
      'Suspension ‚Äì Rear': {
        charlie: "This is what separates the riders from the cryers. Go big or go to the hospital!",
        billy: "The rear shock is important when Charlie talks you into terrible ideas.",
        tbd: "My telemetry indicates the stock spring rate is insufficient for optimal damping."
      },
      'Brakes': {
        charlie: "Brakes are for people who don't commit. But I guess we need them sometimes.",
        billy: "The most important part of the bike, especially when riding with Charlie.",
        tbd: "Brake fluid temperature becomes critical after 7.2 minutes of sustained downhill."
      },
      'Wheels': {
        charlie: "These things take ABUSE. Go strong or go walking!",
        billy: "Wheels are like good fishing spots. Everyone has opinions, most are wrong.",
        tbd: "I've calculated the optimal spoke tension for maximum torsional rigidity."
      },
      'Electronics ‚Äì Throttle & Controls': {
        charlie: "The more sensitive the better. I want it to MOVE when I twitch!",
        billy: "I just want a throttle that works when my hands are cold and wet.",
        tbd: "My throttle response curve has been recalibrated 27 times for optimal delivery."
      },
      'Electronics ‚Äì Wiring': {
        charlie: "Zip ties and electrical tape. The universal solution to everything.",
        billy: "Label everything. Future you will thank you when something breaks.",
        tbd: "I've created a redundant parallel circuit for critical systems."
      },
      'Charger': {
        charlie: "Faster charging means more riding! Science!",
        billy: "Don't cheap out here. A fire in the garage is bad for the fishing gear.",
        tbd: "My charging algorithm extends cell life by an estimated 34.8%."
      }
    };
    
    // Random build comments based on total price
    function getRandomBuildComment(price, name) {
      const buildName = name || "your build";
      
      // Comments for different price ranges
      const priceComments = {
        cheap: [
          { character: "charlie", text: `${buildName}? More like "Budget Betty." But hey, it'll probably survive... the driveway.` },
          { character: "billy", text: `${buildName} looks reasonable. At least you'll have money left for fishing gear.` },
          { character: "tbd", text: `${buildName} is operating at 67.2% of optimal performance potential. Acceptable for beginners.` }
        ],
        mid: [
          { character: "charlie", text: `${buildName} is getting there! Might survive a weekend with the squad.` },
          { character: "billy", text: `${buildName} looks solid. Should get you to the lake and back without breaking down.` },
          { character: "tbd", text: `${buildName} achieves 82.4% performance efficiency. A statistically sound build.` }
        ],
        expensive: [
          { character: "charlie", text: `DUDE! ${buildName} is INSANE! Let's go break it in spectacular fashion!` },
          { character: "billy", text: `Wow. ${buildName} costs more than my first truck. Better not get it muddy... but we will.` },
          { character: "tbd", text: `${buildName} approaches theoretical performance limits. I've added it to my database.` }
        ]
      };
      
      // Determine price range
      let range;
      if (price < 4000) range = "cheap";
      else if (price < 7000) range = "mid";
      else range = "expensive";
      
      // Get random comment for this price range
      const comments = priceComments[range];
      return comments[Math.floor(Math.random() * comments.length)];
    }

    // Format currency properly
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount);
    }

    // Extract price from string safely
    function extractPrice(priceString) {
      // This improved regex handles commas in price format
      const match = priceString.match(/\$([0-9,]+(?:\.[0-9]+)?)/);
      if (match && match[1]) {
        // Remove commas before parsing
        return parseFloat(match[1].replace(/,/g, ''));
      }
      return 0;
    }

    async function loadPartsFromJSON() {
      try {
        // Instead of fetch, use a hardcoded parts array
        const partsData = [
          {
            "Category": "Frame",
            "Part Name & Details": "Sur-Ron frame & chassis - core component that determines the foundation of your build.",
            "Sourcing Option 1 (Price - Vendor)": "$750 - Factory Direct",
            "Sourcing Option 2 (Price - Vendor)": "$899 - Luna Cycle"
          },
          {
            "Category": "Motor",
            "Part Name & Details": "Electric motor - determines power and torque of your bike.",
            "Sourcing Option 1 (Price - Vendor)": "$450 - Sur-Ron Factory",
            "Sourcing Option 2 (Price - Vendor)": "$649 - Performance Upgrade"
          },
          {
            "Category": "Battery",
            "Part Name & Details": "72V lithium battery pack - determines range and continuous power output.",
            "Sourcing Option 1 (Price - Vendor)": "$1,299 - Standard 60V",
            "Sourcing Option 2 (Price - Vendor)": "$2,199 - Premium 72V"
          },
          {
            "Category": "Controller",
            "Part Name & Details": "Electronic speed controller - brain of the electric system.",
            "Sourcing Option 1 (Price - Vendor)": "$379 - Stock Controller",
            "Sourcing Option 2 (Price - Vendor)": "$699 - BAC 8000 Upgrade"
          },
          {
            "Category": "Front Suspension",
            "Part Name & Details": "Front fork - affects handling and ride comfort over rough terrain.",
            "Sourcing Option 1 (Price - Vendor)": "$299 - Standard Fork",
            "Sourcing Option 2 (Price - Vendor)": "$899 - DNM USD-8"
          },
          {
            "Category": "Rear Suspension",
            "Part Name & Details": "Rear shock - balances the bike's response to terrain.",
            "Sourcing Option 1 (Price - Vendor)": "$199 - Stock Shock",
            "Sourcing Option 2 (Price - Vendor)": "$429 - DNM Upgrade"
          },
          {
            "Category": "Brakes",
            "Part Name & Details": "Hydraulic disc brakes - essential for control and safety.",
            "Sourcing Option 1 (Price - Vendor)": "$149 - Stock Tektro",
            "Sourcing Option 2 (Price - Vendor)": "$399 - Magura MT5e"
          },
          {
            "Category": "Wheels & Tires",
            "Part Name & Details": "Wheel set with tires - affects traction, handling and ride feel.",
            "Sourcing Option 1 (Price - Vendor)": "$299 - Stock 19\"/19\"",
            "Sourcing Option 2 (Price - Vendor)": "$499 - 21\"/18\" Upgrade"
          },
          {
            "Category": "Handlebars & Controls",
            "Part Name & Details": "Bars, grips and control levers - customize fit and feel.",
            "Sourcing Option 1 (Price - Vendor)": "$79 - Stock Setup",
            "Sourcing Option 2 (Price - Vendor)": "$199 - Pro Taper Kit"
          },
          {
            "Category": "Throttle",
            "Part Name & Details": "Electronic throttle - controls power delivery.",
            "Sourcing Option 1 (Price - Vendor)": "$39 - Stock Throttle",
            "Sourcing Option 2 (Price - Vendor)": "$89 - Domino Throttle"
          },
          {
            "Category": "Wiring & Display",
            "Part Name & Details": "Electrical system and dashboard display.",
            "Sourcing Option 1 (Price - Vendor)": "$99 - Basic Display",
            "Sourcing Option 2 (Price - Vendor)": "$299 - Color Display"
          },
          {
            "Category": "Seat",
            "Part Name & Details": "Rider seat - affects comfort during long rides.",
            "Sourcing Option 1 (Price - Vendor)": "$59 - Stock Seat",
            "Sourcing Option 2 (Price - Vendor)": "$149 - Comfort Seat"
          },
          {
            "Category": "Charger",
            "Part Name & Details": "Battery charging system - affects recharge time.",
            "Sourcing Option 1 (Price - Vendor)": "$129 - Standard 5A",
            "Sourcing Option 2 (Price - Vendor)": "$299 - Fast 10A"
          }
        ];

        const container = document.getElementById("parts-select");
        container.innerHTML = '';  // Clear container

        // Map part categories to squadComment categories
        function mapCategoryToCommentCategory(category) {
          const categoryMap = {
            "Front Suspension": "Suspension ‚Äì Front",
            "Rear Suspension": "Suspension ‚Äì Rear",
            "Wheels & Tires": "Wheels",
            "Handlebars & Controls": "Electronics ‚Äì Throttle & Controls",
            "Throttle": "Electronics ‚Äì Throttle & Controls",
            "Wiring & Display": "Electronics ‚Äì Wiring"
          };
          
          return categoryMap[category] || category;
        }

        partsData.forEach(part => {
          const section = document.createElement("div");
          section.classList.add("part-selector");

          const label = document.createElement("h3");
          label.textContent = part.Category;
          section.appendChild(label);

          // Description text
          const description = document.createElement("p");
          description.className = "description";
          description.textContent = part["Part Name & Details"];
          section.appendChild(description);

          // Create select element
          const select = document.createElement("select");
          select.dataset.category = part.Category;
          select.addEventListener("change", updateSummary);

          // Add options for each sourcing option
          const options = [
            { text: part["Sourcing Option 1 (Price - Vendor)"], value: extractPrice(part["Sourcing Option 1 (Price - Vendor)"]) },
            { text: part["Sourcing Option 2 (Price - Vendor)"], value: extractPrice(part["Sourcing Option 2 (Price - Vendor)"]) }
          ];

          options.forEach(option => {
            const opt = document.createElement("option");
            opt.value = option.value;
            opt.textContent = option.text;
            select.appendChild(opt);
          });

          section.appendChild(select);

          // Add random squad comment - Map category correctly and handle missing categories
          const commentCategory = mapCategoryToCommentCategory(part.Category);
          
          // Check if we have comments for this category
          if (squadComments[commentCategory]) {
            const commentKeys = Object.keys(squadComments[commentCategory]);
            const randomMember = commentKeys[Math.floor(Math.random() * commentKeys.length)];
            
            const comment = document.createElement("div");
            comment.classList.add("squad-comment", randomMember);
            comment.textContent = squadComments[commentCategory][randomMember];
            section.appendChild(comment);
          } else {
            // Fallback for missing categories - use a generic comment
            const fallbackMembers = ["charlie", "billy", "tbd"];
            const randomMember = fallbackMembers[Math.floor(Math.random() * fallbackMembers.length)];
            
            const comment = document.createElement("div");
            comment.classList.add("squad-comment", randomMember);
            
            let genericComment;
            if (randomMember === "charlie") {
              genericComment = `This ${part.Category} looks awesome! Let's put it to the test!`;
            } else if (randomMember === "billy") {
              genericComment = `A good ${part.Category} is worth every penny.`;
            } else {
              genericComment = `${part.Category} specifications are within acceptable parameters.`;
            }
            
            comment.textContent = genericComment;
            section.appendChild(comment);
          }

          container.appendChild(section);
        });

        updateSummary();
        
        // Check if we're coming from the main build page with selections
        checkForPartSelections();
      } catch (error) {
        console.error("Error loading parts:", error);
        document.getElementById("error-message").style.display = "block";
      }
    }

    function updateSummary() {
      const selections = document.querySelectorAll("#parts-select select");
      const list = document.getElementById("selected-parts-list");
      const total = document.getElementById("total-price");
      const buildName = document.getElementById("build-name").value;
      list.innerHTML = "";

      let sum = 0;
      selections.forEach(sel => {
        const category = sel.dataset.category;
        const option = sel.options[sel.selectedIndex];
        const price = parseFloat(option.value);
        sum += price;

        const li = document.createElement("li");
        li.textContent = `${category}: ${option.textContent}`;
        list.appendChild(li);
      });

      total.textContent = formatCurrency(sum);
      
      // Update squad comment on the build
      const buildComment = document.getElementById("build-comment");
      const comment = getRandomBuildComment(sum, buildName);
      buildComment.className = `squad-comment ${comment.character}`;
      buildComment.textContent = comment.text;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadPartsFromJSON();
      
      // Handle build name changes
      document.getElementById("build-name").addEventListener("input", updateSummary);
      
      // Handle save button
      document.getElementById("save-build").addEventListener("click", saveBuild);
      
      // Handle share button
      document.getElementById("share-build").addEventListener("click", shareBuild);
      
      // Wait for player state to be ready
      document.addEventListener('playerStateReady', function() {
        updatePlayerStats();
        // Show player stats area
        document.getElementById('player-stats').style.display = 'flex';
      });
      
      // If player state already exists, update stats
      if (window.playerState) {
        updatePlayerStats();
        document.getElementById('player-stats').style.display = 'flex';
      }
    });

    function loadSavedBuilds() {
      try {
        // Check if we have a loadBuild parameter in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const loadBuildIndex = urlParams.get('loadBuild');
        
        if (loadBuildIndex !== null) {
          // We're loading a specific build from the saved builds page
          const savedBuilds = JSON.parse(localStorage.getItem('surronSquadBuilds') || '[]');
          
          if (savedBuilds.length > 0 && savedBuilds[loadBuildIndex]) {
            const buildToLoad = savedBuilds[loadBuildIndex];
            
            // Set the build name
            document.getElementById('build-name').value = buildToLoad.name;
            
            // Set the selections based on part prices
            const selects = document.querySelectorAll('#parts-select select');
            
            buildToLoad.parts.forEach(savedPart => {
              // Find the select element for this category
              const categorySelect = Array.from(selects).find(
                select => select.dataset.category === savedPart.category
              );
              
              if (categorySelect) {
                // Find the option with the matching price
                const options = Array.from(categorySelect.options);
                const matchingOption = options.find(
                  option => Math.abs(parseFloat(option.value) - savedPart.price) < 0.01
                );
                
                if (matchingOption) {
                  categorySelect.value = matchingOption.value;
                }
              }
            });
            
            // Update the summary to reflect the loaded build
            updateSummary();
            
            // Show a success message
            alert(`"${buildToLoad.name}" loaded successfully!`);
            
            return; // Exit early, we've loaded the build
          }
        }
        
        // If we didn't load a specific build, check if we should suggest loading one
        const savedBuilds = JSON.parse(localStorage.getItem('surronSquadBuilds') || '[]');
        
        if (savedBuilds.length > 0 && confirm('You have saved builds. Would you like to load your most recent build?')) {
          // Get most recent build
          const mostRecent = savedBuilds[savedBuilds.length - 1];
          
          // Set the build name
          document.getElementById('build-name').value = mostRecent.name;
          
          // TODO: Set the selections based on part names
          // This would require matching the part categories and options
          
          // Update the summary
          if (typeof updateSummary === 'function') {
            updateSummary();
          }
        }
      } catch (error) {
        console.error('Error loading saved builds:', error);
      }
    }
    
    // Function to check for parts selections from the main build page
    function checkForPartSelections() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const fromSelection = urlParams.get('fromSelection');
        
        if (fromSelection === 'true') {
          // Get selected parts from localStorage
          const selectedParts = JSON.parse(localStorage.getItem('selectedSurronParts') || '[]');
          
          if (selectedParts.length > 0) {
            // Map the selected parts to the corresponding categories
            const partCategoryMap = {
              0: 'Frame', // Frame & Chassis maps to Frame
              1: 'Motor',
              2: 'Battery',
              3: 'Controller',
              4: 'Suspension ‚Äì Front', // Suspension maps to Front Suspension (simplified)
              5: 'Brakes',
              7: 'Wheels', // Wheels & Tires maps to Wheels
              8: 'Electronics ‚Äì Throttle & Controls', // Electrical Components maps to Electronics
              9: 'Charger'
            };
            
            // Get all select elements
            const selects = document.querySelectorAll('#parts-select select');
            
            // For each selected part, select the corresponding option (default to option 1)
            selectedParts.forEach(partIndex => {
              const mappedCategory = partCategoryMap[partIndex];
              
              if (mappedCategory) {
                // Find the select for this category
                const categorySelect = Array.from(selects).find(
                  select => select.dataset.category === mappedCategory
                );
                
                if (categorySelect && categorySelect.options.length > 0) {
                  // Default to first option (typically cheaper)
                  categorySelect.selectedIndex = 0;
                }
              }
            });
            
            // Set a default build name that includes the number of selected components
            document.getElementById('build-name').value = `Custom ${selectedParts.length}-Part Build`;
            
            // Update the summary
            updateSummary();
            
            // Show success message
            alert(`Your selected components (${selectedParts.length}) have been loaded! Review and customize your build.`);
          }
        }
      } catch (error) {
        console.error('Error processing selected parts:', error);
      }
    }
    
    function saveBuild() {
      try {
        // Get build name
        const buildName = document.getElementById('build-name').value.trim();
        if (!buildName) {
          alert('Please enter a name for your build!');
          return;
        }
        
        // Get all selected parts
        const selections = document.querySelectorAll('#parts-select select');
        const parts = [];
        
        selections.forEach(sel => {
          const category = sel.dataset.category;
          const option = sel.options[sel.selectedIndex];
          const price = parseFloat(option.value);
          
          parts.push({
            category: category,
            option: option.textContent,
            price: price
          });
        });
        
        // Calculate total price
        const totalPrice = parts.reduce((sum, part) => sum + part.price, 0);
        
        // Create build object
        const build = {
          name: buildName,
          parts: parts,
          totalPrice: totalPrice,
          date: new Date().toISOString()
        };
        
        // Get existing builds or create empty array
        const savedBuilds = JSON.parse(localStorage.getItem('surronSquadBuilds') || '[]');
        
        // Add new build
        savedBuilds.push(build);
        
        // Save to localStorage
        localStorage.setItem('surronSquadBuilds', JSON.stringify(savedBuilds));
        
        // Use the new GameCore-aware saveBuild function
        if (window.saveBuild) {
          // Save to GameCore player state
          const success = window.saveBuild(build);
          
          if (success) {
            alert(`"${buildName}" has been saved to your build library! (+50 XP)`);
          } else {
            alert(`"${buildName}" has been saved to your build library!`);
          }
        } else {
          // Show confirmation if no GameCore saveBuild function
          alert(`"${buildName}" has been saved to your build library!`);
        }
        
      } catch (error) {
        console.error('Error saving build:', error);
        alert('There was an error saving your build. Please try again.');
      }
    }
    
    function shareBuild() {
      alert("The squad would love to see this build, but social sharing is coming in a future update. For now, save your build and show your friends on your device!");
    }
  </script>
</body>
</html>
